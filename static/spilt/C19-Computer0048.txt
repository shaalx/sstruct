	计算机	工程	COMPUTER	ENGINEERING1999	年	第25	卷	第7	期	Vol.25	No.5	1999虚拟	实景	空间	系统	HVS	的	研究	与	实现	张茂军	钟力	孙立峰	李云浩	胡晓峰	摘要	虚拟	实景	空间	系统	HVS	由	计算机	自动	拼接	变形	与	组织	许多	幅	离散	的	实景	图象	或	连续	的	视频	生成	虚拟	空间	这种	虚拟	空间	具有	照片	质量	的	视觉	效果	称为	虚拟	实景	空间	虚拟	实景	空间	能	为	用户	提供	前进	后退	仰视	俯视	360	度	环境	近	看	远	看	等	漫游	能力	可	运行	于	PC	平台	HVS	是	虚拟	实景	空间	的	生成	与	漫游	平台	将	介绍	它	的	模型	组成	与	实现	采用	计算机	图形	技术	是	构造	这样	的	虚拟	环境	的	方法	之一	首先	对	真实	世界	进行	抽象	从而	建立	起	它	的	三维	几何	模型	一般	用	多边形	表示	在	给	定	观察点	和	观察	方向	以后	利用	计算机	由	模型	实现	多边形	着色	消隐	光照	以及	投影	等	一	系列	绘制	过程	产生	虚拟	场景	但	这种	方法	存在	以下	的	问题	一	是	对	计算机	的	性能	要求	高	目前	最	快	的	图形	工作站	每	秒钟	绘制	标准	三维	多边形	的	数目	在	百万	数量级	而	构造	一些	复杂	场景	往往	需要	数亿	个	标准	三维	多边形	为了	能	满足	虚拟	环境	的	实时性	要求	只能	减轻	场景	的	复杂	度	降低	虚拟	场景	的	视觉	效果	二	是	对	复杂	场景	来说	建模	工作	相当	费时	费力	而	基于	实景	图象	的	虚拟	现实	系统	恰好	能	解决	这些	问题		在	虚拟	实景	空间	系统	HVS	中	虚拟	场景	是	按	以下	步骤	生成	的	首先	利用	采集	的	离散	图象	或	连续	的	视频	作为	基础	数据	经过	处理	形成	360	度	柱面	全景	图象	然后	通过	合适	的	空间	模型	把	多	幅	全景	图象	组织	为	虚拟	实景	空间	用户	在	这个	空间	中	可以	前进	后退	360	度	环视	仰视	俯视	近	看	远	看	等	就	像	进入	到	一个	实际	的	空间	一样	虚拟	实景	空间	具有	如下	的	优点		不	需要	硬件	加速	就	能	在	PC	机	上	实时	运行		不	依赖	于	特殊	的	设备	如	头盔	显示器	等		能	显示	高	质量	图象	且	处理	时间	与	场景	复杂度	无关		早	在	1980年	MIT	媒体	实验室	开发	成功	Aspen	Movie	Map	项目	用户	可以	"	浏览	"	模拟	视盘	中	存储	的	Aspen	各个	街道	虽然	受	当时	技术	条件	的	限制	采用	的	是	模拟	技术	但	其	思想	却	是	新颖	超前	的	到	了	90	年代	基于	实景	图象	和	视频	建立	虚拟	环境	在	国际	上	成为	十分	热门	的	研究	课题	单视点	描述	的	系统	像	"	QuickTime	VR	"	和	"	Surrounding	Video	"	先后	已经	用于	旅游	多媒体	光盘	出版	等	很多	方面	在	军事	上	也	有人	将	卫星	拍摄	的	侦察	图象	加工	成	可以	快速	观察	的	空间	图象	在	1997年	美国	发射	的	火星	探路者	往	地球	发	回	了	大量	的	实景	照片	为了	方便	广大	爱好者	观察	这些	照片	很快	便	在	网络	上	出现	在	图象	处理	领域	Image	based	rendering	已经	成为	十分	重要	的	研究	方向	基于	实景	图象	的	方法	建立	虚拟	空间	具有	快速	简单	逼真	等	独特	的	优点	正在	为	越来越	多	的	应用	采纳	值得	说明	的	是	这种	技术	和	基于	图形	的	虚拟	环境	不	是	一	种	取代	关系	而是	一	种	互补	的	关系		但	目前	这些	方法	大都	是	单视点	空间	多	视点	组成	的	虚拟	实景	空间	尚未	看到	虚拟	实景	空间	系统	HVS	瞄准	国际	上	该	领域	的	最新	发展	趋势	几	年	前	便	开始	力图	用	多视点	的	方法	实现	用	实景	图象	建立	虚拟	空间	的	设想	将	其	应用	到	军事	侦察	大型	建筑	和	武器	装备	空间	观察	旅游	空间	的	观察	等	方面	并	于	近期	内	开发	成功	作为	一个	实用	的	系统	HVS	在	虚拟	实景	空间	模型	以及	在	空间	中	对	信息	组织	方法	等	方面	具有	独创性	1		HVS	空间	模型	1.1	视点	空间		定义	1视点	是	指	用户	某	一	时刻	在	虚拟	实景	空间	中	的	观察点	观察	时	所	用	的	焦距	固定		定义	2视点	空间	某	一	视点处	用户	所	观察	到	的	场景		在	视点	空间	的	定义	中	只	限定	了	视点	的	位置	对	观察	方向	未	作	任何	限定	也就是说	视点	空间	应	包含	任意	观察	方向	上	用户	所	看到	的	全局	场景	我们	知道	普通	图象	反映	的	往往	是	局部	场景	用户	在	某	一	视角	看到	的	场景	称为	局部	图象	能	反映	全局	场景	的	图象	称为	全景	图象	Panaromic	Image	全景	图象	是	视点	空间	合适	的	描述	形式	之一		存在	几	种	全景	图象	一	种	是	球面	全景	图象	一	种	是	多面体	全景	图象	还有	一	种	是	最	常用	的	柱面	全景	图象	如	图	1	它们	分别	把	视点	空间	看作	是	球体	多面体	与	圆柱体	球面	全景	与	多面体	全景	均	可	反映	空间	中	任意	方向	的	场景	处理	它们	的	难度	比较	大	柱面	全景	实际上	是	它们	的	简化	形式	如	图	2	柱面	全景	没有	顶盖	与	底盖	两	部分	场景	限制	了	用户	在	垂直	方向	的	观察	角度	但	在	水平	方向	是	360	度	视角	满足	大部分	应用	的	需要	而	柱面	全景	处理	起来	比	球面	全景	与	多面体	全景	简单	得	多	因而	应用	面	比较	广	HVS	也	是	采用	柱面	全景	图象	来	反映	视点	空间	的	图	1	立方体	全景图	图象	球	面	全景	图象	和	柱面	全景	图象图	2	柱	面	全景	图象	概念图	1.2		虚拟	实景	空间		单个	的	视点	空间	反映	的	是	一个	三维点	空间	而	一个	虚拟	现实	系统	往往	需要	建立	起	一个	N	维	的	虚拟	空间	N	维虚拟	空间	应	具备	什么样	的	特性	呢	我们	认为	首先	N	维虚拟	空间	应	能	反映	现实	世界	的	三维	空间	当然	这样	的	空间	不仅仅	是	点	空间	在	点	空间	内	用户	只能	靠	改变	视角	来	观察	不同	的	场景	N	维虚拟	空间	应	支持	用户	通过	改变	空间	位置	来	观察	不同	的	场景	其次	N	维虚拟	空间	还	应	能	反映	虚拟	空间	在	时间	上	的	变化	如	白天	与	黑夜	的	变化	风景	名胜	随	季节	的	变化	等	除此之外	还	考虑	了	一	种	特殊	的	情况	在	虚拟	空间	中	视点	间	的	变换	也许	不仅仅	局限	于	物理	时空	比如	用	HVS	构建	一	栋	虚拟	的	教学	大楼	这	栋	虚拟	大楼	基本上	是	按	大楼	的	原貌	建	的	只是	有	一	间	房间	是	虚拟	的	美国	总统	克林顿	办公室	在	这样	的	虚拟	大楼	内	参观	观众	将	会	沉浸	到	大楼	中	但	也	会	突然	进入	到	克林顿	的	办公室	这	便	给	观众	一	种	跨越	时空	的	感觉	而	超越	于	现实	时空	又	恰恰	是	虚拟	现实	系统	的	特性	之一	为此	需要	给	N	维虚拟	空间	增加	"	虚化	"	的	能力	1.3		空间	操纵		建立	虚拟	空间	的	目的	是	为了	让	用户	可以	通过	一定	的	手段	漫游	于	其中	从	这个	意义	上	说	漫游	的	过程	实质	上	便是	操纵	虚拟	空间	的	过程	虚拟	实景	空间	的	操纵	包括	两	部分	视点	空间	内	操纵	与	视点	空间间	操纵	视点	空间	内	操纵	主要	是	操纵	视角	由于	用户	任	一	时刻	的	视野	不	会	大于	180°	而	全景	图象	是	360	°	全	视野	因而	任	一	时刻	用户	观察	到	的	场景	只	是	全景	图象	的	一	部分	通过	视点	空间	内	操纵	用户	可以	看到	全景	图象	的	其它	部分	视点	空间	内	操纵	一般	包括	向	左	旋转	相当	于	用户	向	左	看	向	右	旋转	相当	于	用户	向	右	看	向上	移动	相当	于	仰视	向下	移动	相当	于	俯视	4	种		视点	空间	间	的	操纵	则	建立	在	视点	空间	之间	的	关联	上	比如	视点	空间	VPS1	与	视点	空间	VPS2	在	空间	位置	上	是	相邻	的	这种	关联	称为	位置	关联	用户	从	视点	空间	VPS1	过渡	到	空间	VPS2	相当	于	用户	从	VPS1	的	位置	行进	到	VPS2	的	位置	反之亦然	除了	位置	关联	外	HVS	实现	的	关联	形式	还有	时间	关联	虚化	关联	与	焦距	关联		设	视点	空间	VPS1	与	VPS2	时间	关联	那么	这	两	个	视点	空间	分别	反映	在	同一个	视点处	不同	时刻	所	看到	的	全景	场景		设	视点	空间	VPS1	与	VPS2	虚化	关联	那么	由	VPS1	可以	过渡	到	VPS2	不	包含	任何	物理	时空	的	含义		设	视点	空间	VPS1	与	VPS2	焦距	关联	那么	这	两	个	视点	空间	分别	反映	在	同一个	视点处	用户	使用	不同	焦距	所	看到	的	全景	图象	焦距	关联	可以	理解	为	虚化	关联	的	一	种		位置	关联	时间	关联	虚化	关联	与	焦距	关联	分别	赋予	了	虚拟	实景	空间	的	4	种	不同	的	特性	由于	有	位置	关联	用户	可以	在	虚拟	实景	空间	中	前进	与	后退	由于	有	时间	关联	用户	在	虚拟	实景	空间	中	可以	体会	到	季节	朝暮	等	时间	上	的	变化	由于	有	焦距	关联	在	虚拟	实景	空间	中	用户	可以	近	看	看	得	更	仔细	或	远	看	看到	整体	由于	有	虚化	关联	虚拟	实景	空间	能	反映	一些	超现实	的	场景	变化		在	HVS	系统	中	我们	借助	超	媒体	系统	中	的	"	链	"	来	描述	视点	空间	间	的	关联	依照	关联	的	种类	链	有	"	位置链	"	Lp	"	时间链	"	Lt	"	虚化链	"	Lv	与	"	焦距链	"	Lf	4	种	链	是	单向	的	每	一个	关联	实际上	由	两	个	链	描述	如	VPS1	与	VPS2	之间	的	位置	关联	可以	等	价于链	Lp1	V1	V2	Property	p1	和	链	LP2	V1	V2	Property	p2	其中	p1	与	p2	分别	表示	两	个	不同	的	视点	Property	p1	与	Property	p2	为链	的	属性	分别	表示	从	V1	到	V2	与	从	V2	到	V1	时空	位置	的	变化值	2		HVS	系统	组成	与	实现		HVS	的	功能	可以	归结	为	两	点	一	是	生成	虚拟	实景	空间	二	是	提供	一定	的	手段	使	用户	能	在	虚拟	实景	空间	中	漫游	HVS	系统	分为	两	部分	虚拟	实景	空间	生成	平台	与	虚拟	实景	空间	浏览器	生成	平台	又	分为	全景	图象	生成器	与	可视化	编辑器	前者	负责	把	多	幅	相互	间	有	少量	重叠	区域	的	普通	图象	或	连续	的	视频	拼接	为	全景	图象	把	众多	的	全景	图象	组织	为	虚拟	实景	空间	的	功能	则	是	由	可视化	编辑器	实现	的	编辑	过程	可视化	便于	操作	生成	虚拟	实景	空间	的	过程	如	图	3	所	示	图	3	虚拟	实景	空间	生成	流程	2.1		全景	图象	生成器	柱面	全景	图象	可以	由	照相机	或	摄象机	采集	数据	生成	将	照相机	或	摄象机	固定	在	可	水平	旋转	的	支架	上	照相机	或	摄象机	的	镜头	需	位于	支架	的	中心	点	如果	是	照相机	转动	照相机	一	周	并	隔	一定	角度	拍照	把	得到	的	相互	间	有	一定	接缝	的	一	圈	局部	图象	用于	全景	图象	生成器	的	输入	如果	采用	摄象机	生成	全景	图象	则	把	摄象机	缓慢	地	绕	中心	点	旋转	一	圈	拍摄	得到	的	视频	作为	全景	图象	生成器	的	输入		由	连续	视频	拼接	全景	图象	的	快速	算法	已	有	研究	成果	2	在	实际	应用	的	过程	中	发现	摄象机	视频	图象	分辨率	较	低	影响	了	HVS	系统	的	视觉	效果	特别	是	对于	由	家用型	摄象机	采集	到	的	视频	所以	倾向	于	用	照相机	采集	HVS	所	需	的	原始	数据	数码	相机	最	合适	下面	主要	针对	使用	照相机	的	情况	介绍	全景	图象	生成器	的	实现		由于	局部	图象	Lii	与	Lij	i	≠	j	分别	是	在	不同	方向	上	拍	下	的	图象	它们	的	投影	平面	存在	一定	的	夹角	在	拼接	全景	图象	之前	必须	把	它们	统一	投影	到	某	一	柱面	上	使得	现实	世界	中	相同	的	景物	在	不同	的	局部	图象	中	是	相同	的	图	4	显示	了	柱面	投影	的	一个	实例	具体	算法	参见	文献	6	得到	投影	图象	后	进行	无缝	拼接	就	能	得到	没有	图象	畸变	的	全景	图象	如	图	5	图	4		柱面	投影	图	5		一	幅	全景	图象	2.2		可视化	编辑器		可视化	编辑器	是	HVS	系统	的	重要	组成部分	它	能	把	本来	互不	相干	的	全景	图象	组织	成	用户	可	任意	漫游	的	虚拟	实景	空间	依据	HVS	空间	模型	可视化	编辑器	主要	负责	生成	各种	链	赋予	链属性	等	为	使	用户	在	虚拟	实景	空间	中	漫游	时	不致	迷失	方向	HVS	可视化	编辑器	中	引入	了	"	导航	图	"	导航	图	相当	于	虚拟	实景	空间	的	一	幅	地图	虚拟	实景	空间	中	各个	视点	的	位置	以及	用户	当前	的	位置	等	均	动态	绘制	在	导航	图	中	在	漫游	时	用户	可	随时	查看	导航	图		在	HVS	中	一	幅	柱面	全景	图象	的	分辨率	是	4096	600	24	位	真	彩色	其	数据量	是	7.2Mb	而	一个	虚拟	实景	空间	的	全景	图象	一般	都	有	成百上千	幅	很	显然	如此	巨大	的	数据量	既	增加	了	系统	管理	的	难度	也	造成	了	不必要	的	存储	资源	浪费	所以	进行	图象	压缩	势在必行		HVS	系统	采用	标准	的	JPEG	算法	对	全景	图象	进行	压缩	但	在	具体	操作	上	是	把	全景	图象	垂直	分块	分成	大	小	相等	的	一	系列	子图	例如	每块	为	64	600	在	压缩	时	对	每个	子图	分别	进行	压缩	然后	依次	存放	在	文件	中	并	在	文件	头	添加	一个	子图索引	以便	随机	访问	考虑	到	各个	子图	是	按照	同一	标准	压缩	所以	它们	可	共	用	同一	套码表	包括	huffman	码表	和	量化表	以	提高	压缩	效率	子图	的	最	优	宽度	受	CPU	速度	硬盘	速度	以及	JPEG	算法	本身	的	影响	因为	JPEG	标准	是	按	8	8	作	DCT	变换	的	因此	子图	宽度	是	8	的	倍数	比较	好	实践	证明	64象素	宽	的	子图	对	HVS	的	实时	解压	浏览	最	合适	2.3		浏览器		浏览器	是	提供	给	最终	用户	漫游	虚拟	实景	空间	时	使用	的	运行	浏览器	打开	HVS	空间	文件	后	用户	首先	看到	的	是	导航	图	在	导航	图	中	任意	位置	处	指点	鼠标	按钮	便	可以	进入	到	相应	位置	的	视点	空间	中	在	虚拟	实景	空间	中	用户	可以	用	键盘	鼠标	与	游戏	操纵杆	控制	漫游	方向	穿行	于	各个	视点	空间	中	当	用户	向	左	看	时	全景	图象	向	右	移动	当	用户	向	右	看	时	全景	图象	向	左	移动	当	用户	俯视	时	全景	图象	向上	移动	当	用户	仰视	时	全景	图象	向	下	移动	点	一下	近	看	的	图标	焦距	大	的	全景	图象	被	逐步	显示	出来	点	远	看	的	图标	时	焦距	小	的	全景	图象	被	逐步	显示	点	一下	前进	的	图标	时	系统	将	平滑	过渡	到	下	一个	视点	空间		为	使	用户	看到	的	场景	是	连续	平滑	的	浏览器	需要	解决	一些	关键	技术	首先	是	全景	图象	数据	预调	技术	由于	整	幅	全景	图象	数据量	比较	大	而且	浏览器	一	次	只	显示	全景	图象	的	一	部分	因此	HVS	浏览器	进入	到	一个	视点	空间	时	没有	把	整	幅	全景图	象	一次性	调入	内存	中	而是	只	调入	可见	部分	解压	显示	在	屏幕	窗口	但	考虑	到	用户	可能	需要	左右	移动	全景	图象	HVS	浏览器	提出	了	"	双向	流	缓冲	机制	"	5	预调	恰当	的	全景图	象解	压缓	存在	内存	中		其二	在	漫游	虚拟	实景	空间	时	用户	的	前进	与	后退	近	看	与	远	看	等	涉及	到	下	一个	视点	空间	的	显示	用户	可能	到达	的	下	一个	视点	空间	数目	由	当前	视点	空间	的	链	决定	若	把	这些	视点	空间	都	预调	到	内存	中	显然	会	降低	系统	实时	性能	并	占用	大量	系统	资源	所以	HVS	提出	"	状态	相关	的	预测	路径	全景	图象	缓冲	机制	"	5	预调	恰当	的	视点	空间	到	内存		其三	当	用户	沿	位置链	从	当前	空间	位置	行进	到	另	一个	空间	位置	时	HVS	浏览器	需要	解决	把	当前	屏幕	上	的	图象	平滑	过渡	到	另	一	幅	图象	的	问题	如果	浏览器	只是	简单	地	把	当前	图象	切换	为	另	一	幅	图象	是	无法	使	用户	产生	在	空间	行进	的	感觉	为此	HVS	系统	提出	了	"	纵平	移	图象	平滑	过渡	技术	"	该	技术	提供	了	两	种	技术	解决	方案	一	是	图象	插值	法	5	6	即	计算机	由	起始	图象	到	终点	图象	并	结合	其它	信息	实时	地	计算	出	中间帧	并	依次	显示	在	屏幕	上	二	是	参考	点法	5	6	在	采集	全景	图象	时	便	在	相邻	视点	之间	沿	轴线	采集	多	幅	参考	图象	如	图	6	参考	图象	不	是	柱面	全景	它	的	图象	分辨率	由	浏览器	决定	如	浏览器	表现	虚拟	实景	空间	所	用	的	窗口	大小	为	800	500	象素点	则	参考	图象	的	分辨率	也	是	800	500	或	稍	大	在	纵平	移	图象	平滑	过渡	时	参考	图象	被	作为	中间帧	依次	显示	在	实际	应用	过程	中	两	种	方法	可以	任选	在	起始	与	终点	图象	中	各	象素点	景深	变化	不	大	时	用	图象	插值	法	可	得到	比较	好	的	效果	否则	应	考虑	参考	点法	或	两	种	方法	结合	使用	我们	在	跟踪	研究	多年	的	基础	上	最近	开发	成功	HVS	系统	本文	介绍	了	HVS	系统	的	空间	模型	系统	组成	以及	实现	今后	我们	将	对	视点	间	过渡	技术	进行	进一步	研究	拟	现实	技术	的	一个	重要	的	发展	方向	我们	在	跟踪	研究	多年	的	基础	上	最近	开发	成功	HVS	系统	本文	介绍	了	HVS	系统	的	空间	模型	系统	组成	以及	实现	今后	我们	将	对	视点	间	过渡	技术	进行	进一步	研究	作者	简介	张茂军	男	28	岁	博士	主要	研究	方向	包括	虚拟	现实	系统	多媒体	通信	多媒体	信息	系统	等	作者	单位	张茂军	钟力	孙	立峰		李云浩		国防	科技	大学	七	系	长沙	410073	胡晓峰		国防	大学	电教	中心	北京	100091	参考	文献	1		胡晓峰	老松杨	张茂军	.HVS	一个半	现实	全景图	时空	模型.	小型	微型	计算机	系统	1994	15	12	13-182		张茂军	胡晓峰	库锡树	摄象机	运动	建模	以及	从	视频	中	估计	摄象机	运动	参数	的	一	种	方法	中国	图象	图形	学报	1997	2	8	623-6283	钟力	胡晓峰.	全景	视频	的	信息	组织	和	实现	方法.	小型	微型	计算机	系统	1996	17	12	1-54	钟力	胡晓峰	孙立峰.	全景	视频	信息	空间	模型.	小型	微型	计算机	系统	1997	18	11	31-355	张茂军.	基于	实景	图象	的	虚拟	现实	系统	HVS	设计	报告.	长沙	国防	科技	大学	七	系	1998-066	钟	力.	虚拟	实景	空间	研究	与	实现	长沙	国防	科技	大学	七	系	博士	论文	1998-097		Chen	S	E.QuickTime	VR	An	Image-Based	Approach	to	Virtual	Environment	Navigation	Computer	Graphics	Proceed-ings.Annual	Conference	Series	1995	29-38	收稿	日期	1998-08-03	